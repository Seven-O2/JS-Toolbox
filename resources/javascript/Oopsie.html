<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>OOPSIE</title>
  <style>
    .field {
      float: left;
      margin: 0.2em;
      width: 3em;
      height: 3em;
      background: lightgrey;
      border-color: lightgrey;
      border-width: 3px;
      border-style: solid;
    }

    .fallback1 {
      border-color: blue;
      border-width: 3px;
    }

    .fallback2 {
      border-color: red;
      border-width: 3px;
    }

    .progress1 {
      background: blue;
    }

    .progress2 {
      background: red;
    }

    #dice {
      clear: both;
    }
  </style>
  <script src="oopsie.js"></script>
</head>


<body onload="start()">


  <div id="fields">

  </div>

  <div id="dice">
    []
  </div>

  <div>
    <button onclick="dice()">Throw dice</button>
    <button onclick="turn()">Turn</button>
  </div>

  <script>
    function Player(givenName) {
      let name = givenName;
      let fallbackIndex = 0;
      let progressIndex = 0;
      return {
        proceed: function (stride) {
          progressIndex += stride;
        },
        fallback: function () {
          progressIndex = fallbackIndex;
        },
        turn: function () {
          fallbackIndex = progressIndex;
        },
        getFallbackIndex: function () {
          return fallbackIndex;
        },
        getProgressIndex: function () {
          return progressIndex;
        },
        getName: function () {
          return name;
        },
        reset: function () {
          fallbackIndex = 0;
          progressIndex = 0;
        }
      }
    }


    function start() {
      const fields = document.getElementById('fields');

      for (let i = 0; i < 100; i++) {
        const field = document.createElement("DIV");
        field.setAttribute("ID", "FIELD-" + i);
        field.textContent = " ";
        fields.appendChild(field);
      }
      display();
    }

    function dice() {
      const stride = Math.round(1 + Math.random() * 5);
      document.getElementById('dice').innerText = "" + stride;
      if (stride === 3) {
        player.fallback();
        switchPlayer();
      } else {
        player.proceed(stride);
        if (player.getProgressIndex() === otherPlayer.getProgressIndex()) {
          otherPlayer.reset();
        }
      }
      display();
    }

    function turn() {
      player.turn();
      switchPlayer();
      display();
    }

    function display() {
      for (let i = 0; i < 100; i++) {
        const field = document.getElementById("FIELD-" + i);
        field.setAttribute("CLASS", "field");
      }

      const fallbackField1 = document.getElementById("FIELD-" + player1.getFallbackIndex());
      fallbackField1.setAttribute("CLASS", "field fallback1");
      const progressField1 = document.getElementById("FIELD-" + player1.getProgressIndex());
      progressField1.setAttribute("CLASS", "field progress1");
      const fallbackField2 = document.getElementById("FIELD-" + player2.getFallbackIndex());
      fallbackField2.setAttribute("CLASS", "field fallback2");
      const progressField2 = document.getElementById("FIELD-" + player2.getProgressIndex());
      progressField2.setAttribute("CLASS", "field progress2");
    }

    function switchPlayer() {
      [player, otherPlayer] = [otherPlayer, player];
    }

    player1 = Player("One");
    player2 = Player("Two");
    player = player1;
    otherPlayer = player2;

  </script>
</body>

</html>